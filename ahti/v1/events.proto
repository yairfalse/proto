// events.proto - AHTI's unified event format
//
// This is the canonical event format for the observability platform.
// POLKU transforms raw events (tapio, portti, elava) into this format.
// AHTI consumes these events and builds the infrastructure graph.

syntax = "proto3";

package ahti.v1;

import "google/protobuf/timestamp.proto";

// AhtiEvent is the unified event format for the observability platform
message AhtiEvent {
    // Identity
    string id = 1;                              // ULID
    google.protobuf.Timestamp timestamp = 2;

    // Classification
    EventType type = 3;
    string subtype = 4;                         // e.g., "connection_reset", "oom_kill"
    Severity severity = 5;
    Outcome outcome = 6;

    // Source
    string source = 7;                          // Observer/collector name (tapio, portti, elava)

    // Distributed tracing (optional)
    string trace_id = 8;
    string span_id = 9;
    string parent_span_id = 10;
    uint64 duration_us = 11;                    // Duration in microseconds

    // Graph correlation (key for AHTI)
    repeated Entity entities = 12;
    repeated Relationship relationships = 13;

    // Context
    string cluster = 14;
    string namespace = 15;
    map<string, string> labels = 16;

    // Error details (present when outcome = FAILURE)
    EventError error = 17;

    // Type-specific data (only one populated per event)
    oneof data {
        NetworkEventData network = 20;
        KernelEventData kernel = 21;
        ContainerEventData container = 22;
        K8sEventData k8s = 23;
        ProcessEventData process = 24;
        ResourceEventData resource = 25;
    }
}

// Event types (12 base types)
enum EventType {
    EVENT_TYPE_UNSPECIFIED = 0;
    EVENT_TYPE_NETWORK = 1;
    EVENT_TYPE_KERNEL = 2;
    EVENT_TYPE_CONTAINER = 3;
    EVENT_TYPE_DEPLOYMENT = 4;
    EVENT_TYPE_POD = 5;
    EVENT_TYPE_SERVICE = 6;
    EVENT_TYPE_VOLUME = 7;
    EVENT_TYPE_CONFIG = 8;
    EVENT_TYPE_HEALTH = 9;
    EVENT_TYPE_PERFORMANCE = 10;
    EVENT_TYPE_RESOURCE = 11;
    EVENT_TYPE_CLUSTER = 12;
}

enum Severity {
    SEVERITY_UNSPECIFIED = 0;
    SEVERITY_DEBUG = 1;
    SEVERITY_INFO = 2;
    SEVERITY_WARNING = 3;
    SEVERITY_ERROR = 4;
    SEVERITY_CRITICAL = 5;
}

enum Outcome {
    OUTCOME_UNSPECIFIED = 0;
    OUTCOME_SUCCESS = 1;
    OUTCOME_FAILURE = 2;
    OUTCOME_TIMEOUT = 3;
    OUTCOME_UNKNOWN = 4;
}

// =============================================================================
// GRAPH TYPES (for AHTI's infrastructure graph)
// =============================================================================

// Entity is a node in the infrastructure graph
message Entity {
    EntityType type = 1;
    string id = 2;                              // UID or unique identifier
    string name = 3;
    string cluster_id = 4;
    string namespace = 5;
    map<string, string> labels = 6;
    map<string, string> attributes = 7;         // Type-specific attributes

    // MVCC fields
    int64 generation = 8;
    EntityState state = 9;
    google.protobuf.Timestamp deleted_at = 10;
    string delete_reason = 11;
}

enum EntityType {
    ENTITY_TYPE_UNSPECIFIED = 0;
    ENTITY_TYPE_POD = 1;
    ENTITY_TYPE_CONTAINER = 2;
    ENTITY_TYPE_NODE = 3;
    ENTITY_TYPE_DEPLOYMENT = 4;
    ENTITY_TYPE_STATEFULSET = 5;
    ENTITY_TYPE_DAEMONSET = 6;
    ENTITY_TYPE_SERVICE = 7;
    ENTITY_TYPE_ENDPOINT = 8;
    ENTITY_TYPE_CONFIGMAP = 9;
    ENTITY_TYPE_SECRET = 10;
    ENTITY_TYPE_PVC = 11;
    ENTITY_TYPE_NAMESPACE = 12;
}

enum EntityState {
    ENTITY_STATE_UNSPECIFIED = 0;
    ENTITY_STATE_ACTIVE = 1;
    ENTITY_STATE_DELETED = 2;
}

// Relationship is an edge in the infrastructure graph
message Relationship {
    RelationshipType type = 1;
    EntityReference source = 2;
    EntityReference target = 3;
    map<string, string> labels = 4;

    // MVCC fields
    int64 generation = 5;
    RelationshipState state = 6;
    google.protobuf.Timestamp deleted_at = 7;
    string delete_reason = 8;
    google.protobuf.Timestamp created_at = 9;
}

enum RelationshipType {
    RELATIONSHIP_TYPE_UNSPECIFIED = 0;
    RELATIONSHIP_TYPE_CONNECTS_TO = 1;
    RELATIONSHIP_TYPE_DEPENDS_ON = 2;
    RELATIONSHIP_TYPE_OWNS = 3;
    RELATIONSHIP_TYPE_EXPOSES = 4;
    RELATIONSHIP_TYPE_MOUNTS = 5;
    RELATIONSHIP_TYPE_SCHEDULED_ON = 6;
    RELATIONSHIP_TYPE_MANAGES = 7;
    RELATIONSHIP_TYPE_USES = 8;
    RELATIONSHIP_TYPE_CAUSES = 9;
}

enum RelationshipState {
    RELATIONSHIP_STATE_UNSPECIFIED = 0;
    RELATIONSHIP_STATE_ACTIVE = 1;
    RELATIONSHIP_STATE_DELETED = 2;
}

message EntityReference {
    EntityType type = 1;
    string id = 2;
    string cluster_id = 3;
}

message EventError {
    string code = 1;
    string message = 2;
    map<string, string> details = 3;
}

// =============================================================================
// EVENT DATA TYPES
// =============================================================================

message NetworkEventData {
    string protocol = 1;                        // TCP, UDP, DNS, HTTP, gRPC
    string src_ip = 2;
    string dst_ip = 3;
    uint32 src_port = 4;
    uint32 dst_port = 5;
    string direction = 6;                       // inbound, outbound

    // DNS
    string dns_query = 7;
    string dns_response = 8;

    // HTTP
    string http_method = 9;
    string http_path = 10;
    int32 http_status_code = 11;

    // Metrics
    double latency_ms = 12;
    uint64 bytes_sent = 13;
    uint64 bytes_received = 14;

    // TCP performance
    double rtt_baseline_ms = 15;
    double rtt_current_ms = 16;
    double rtt_degradation_pct = 17;
    uint32 retransmit_count = 18;
    string tcp_state = 19;

    // K8s context
    string process_name = 20;
    string container_id = 21;
    string pod_name = 22;
}

message KernelEventData {
    string event_type = 1;                      // oom_kill, signal, syscall
    uint32 pid = 2;
    string command = 3;

    // OOM
    uint32 oom_victim_pid = 4;
    string oom_victim_comm = 5;
    uint64 memory_requested = 6;

    // Signals
    uint32 signal = 7;
    uint32 signal_code = 8;

    // Syscalls
    uint32 syscall_id = 9;
    string syscall_name = 10;
    int64 syscall_retval = 11;
}

message ContainerEventData {
    string container_id = 1;
    string container_name = 2;
    string image = 3;
    string state = 4;                           // running, stopped, crashed
    int32 exit_code = 5;
    int32 restart_count = 6;
    google.protobuf.Timestamp start_time = 7;

    // Resources
    double cpu_usage = 8;                       // cores
    uint64 memory_usage = 9;                    // bytes
    uint64 memory_limit = 10;
    uint64 disk_usage = 11;

    // OOM details
    int32 signal = 12;
    string cgroup_path = 13;
}

message K8sEventData {
    string resource_type = 1;                   // Deployment, Pod, Service
    string resource_name = 2;
    string namespace = 3;
    string reason = 4;                          // Scheduled, Pulling, Created, Started
    string message = 5;

    // Deployment specifics
    int32 replicas = 6;
    int32 ready_replicas = 7;
    int32 updated_replicas = 8;
    string rollout_status = 9;                  // progressing, complete, failed
}

message ProcessEventData {
    uint32 pid = 1;
    uint32 ppid = 2;
    string command = 3;
    string args = 4;
    uint32 uid = 5;
    uint32 gid = 6;
    string user = 7;
    int32 exit_code = 8;
    google.protobuf.Timestamp start_time = 9;
    google.protobuf.Timestamp end_time = 10;
}

message ResourceEventData {
    string resource_type = 1;                   // cpu, memory, disk, network
    string node_name = 2;

    // CPU
    double cpu_usage_pct = 3;
    double cpu_throttle_pct = 4;

    // Memory
    uint64 memory_used = 5;
    uint64 memory_available = 6;
    double memory_pressure = 7;

    // Disk
    uint64 disk_used = 8;
    uint64 disk_available = 9;
    double disk_io_utilization = 10;
}
